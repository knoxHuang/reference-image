"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCurrentString = exports.hasKey = exports.getString = exports.setCurrentLanguage = void 0;
const path = require("path");
const fs = require("fs");
const cfgInfo = require("./strings");
// const CONFIGFILENAME = "strings.json";
const DEFAULTLANGUAGE = "en";
let locale = null;
let curLangString = null;
let defaultLangString = null;
function getEnvLocale() {
    const defaultRet = { lang: "en" };
    let env = process.env;
    let langEncoding = env.LCALL || env.LCMESSAGES || env.LANG || env.LANGUAGE || Intl.DateTimeFormat().resolvedOptions().locale;
    if (!langEncoding) {
        return defaultRet;
    }
    let p2 = langEncoding.split(".");
    return { lang: p2[0] || defaultRet.lang };
}
function getAvaiableLangs() {
    if (!!cfgInfo) {
        return Object.keys(cfgInfo);
    }
    return [];
}
function getLangKey(lang) {
    let p2 = lang.split("_");
    if (p2[0] == "zh")
        return (p2.length == 1 || p2[1] == "cn") ? "zh" : "zhTr";
    return p2[0];
}
function doInit() {
    locale = getEnvLocale();
    curLangString = cfgInfo[getLangKey(locale.lang)];
    if (!curLangString) {
        curLangString = cfgInfo[DEFAULTLANGUAGE];
    }
    defaultLangString = cfgInfo[DEFAULTLANGUAGE];
}
doInit();
function setCurrentLanguage(lang) {
    let langKey = getLangKey(lang);
    if (lang in cfgInfo) {
        curLangString = cfgInfo[lang];
        locale.lang = lang;
    }
    else if (langKey in cfgInfo) {
        curLangString = cfgInfo[langKey];
        locale.lang = langKey;
    }
    else {
        console.warn();
    }
}
exports.setCurrentLanguage = setCurrentLanguage;
function getString(key, ...fmts) {
    if (curLangString) {
        let fmt = curLangString[key];
        if (!fmt) {
            return `[KEY "${key}" is not found! lang: ${locale.lang}]`;
        }
        if (fmts.length == 0) {
            return fmt;
        }
        let chars = Array.from(fmt);
        let ret = [];
        let len = chars.length;
        let p = 0;
        let ai = 0;
        let placeHolders = 0;
        while (p < len) {
            if (chars[p] == "%") {
                if (chars[p + 1] == "d" || chars[p + 1] == "f") {
                    ret.push(fmts[ai++] + ""); // %d | %f
                    placeHolders++;
                }
                else if (chars[p + 1] == "s") {
                    ret.push(fmts[ai++] + ""); // %s
                    placeHolders++;
                }
                else if (chars[p + 1] == "%") {
                    ret.push("%"); // %%
                }
                else {
                    // unknown formatter?
                    ret.push(fmts[ai++] + ""); // %?
                    placeHolders++;
                }
                p += 2;
            }
            else {
                ret.push(chars[p]);
                p += 1;
            }
        }
        if (placeHolders != fmts.length) {
            console.error(`format argument mismatch: ${fmt} & ${fmts.join(", ")}`);
        }
        return ret.join("");
    }
    return `[language ${locale.lang} not set, key ${key}]`;
}
exports.getString = getString;
function hasKey(key, data) {
    return !!data && (key in data);
}
exports.hasKey = hasKey;
function getCurrentString(key) {
    let ret;
    if (hasKey(key, curLangString)) {
        ret = curLangString[key];
    }
    else if (hasKey(key, defaultLangString)) {
        ret = defaultLangString[key];
    }
    return ret || key;
}
exports.getCurrentString = getCurrentString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlMYW5ndWFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2VkaXRvci0zZC1kZXYvYXBwL3BsYXRmb3Jtcy9pbnRlcm5hbC9uYXRpdmUvc291cmNlL2NvbnNvbGUvbXVsdGlMYW5ndWFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUdyQyx5Q0FBeUM7QUFDekMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDO0FBTzdCLElBQUksTUFBTSxHQUFzQixJQUFJLENBQUM7QUFDckMsSUFBSSxhQUFhLEdBQXFDLElBQUksQ0FBQztBQUMzRCxJQUFJLGlCQUFpQixHQUFxQyxJQUFJLENBQUM7QUFFL0QsU0FBUyxZQUFZO0lBQ2pCLE1BQU0sVUFBVSxHQUFHLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBQyxDQUFDO0lBQ2hDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDdEIsSUFBSSxZQUFZLEdBQUcsR0FBRyxDQUFDLEtBQUssSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsZUFBZSxFQUFFLENBQUMsTUFBTSxDQUFDO0lBQzdILElBQUksQ0FBQyxZQUFZLEVBQUU7UUFDZixPQUFPLFVBQVUsQ0FBQztLQUNyQjtJQUNELElBQUksRUFBRSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakMsT0FBTyxFQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksVUFBVSxDQUFDLElBQUksRUFBQyxDQUFDO0FBQzVDLENBQUM7QUFFRCxTQUFTLGdCQUFnQjtJQUNyQixJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUU7UUFDWCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDL0I7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFZO0lBQzVCLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekIsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSTtRQUNiLE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQzdELE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxTQUFTLE1BQU07SUFDWCxNQUFNLEdBQUcsWUFBWSxFQUFFLENBQUM7SUFDeEIsYUFBYSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDakQsSUFBSSxDQUFDLGFBQWEsRUFBRTtRQUNoQixhQUFhLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0tBQzVDO0lBQ0QsaUJBQWlCLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ2pELENBQUM7QUFFRCxNQUFNLEVBQUUsQ0FBQztBQUVULFNBQWdCLGtCQUFrQixDQUFDLElBQVk7SUFDM0MsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9CLElBQUksSUFBSSxJQUFJLE9BQU8sRUFBRTtRQUNqQixhQUFhLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLE1BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0tBQ3ZCO1NBQU0sSUFBSSxPQUFPLElBQUksT0FBTyxFQUFFO1FBQzNCLGFBQWEsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakMsTUFBTyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7S0FDMUI7U0FBTTtRQUNILE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtLQUNqQjtBQUNMLENBQUM7QUFYRCxnREFXQztBQUdELFNBQWdCLFNBQVMsQ0FBQyxHQUFXLEVBQUUsR0FBRyxJQUF5QjtJQUMvRCxJQUFJLGFBQWEsRUFBRTtRQUNmLElBQUksR0FBRyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ04sT0FBTyxTQUFTLEdBQUcseUJBQXlCLE1BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQTtTQUM5RDtRQUNELElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDbEIsT0FBTyxHQUFHLENBQUM7U0FDZDtRQUVELElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUIsSUFBSSxHQUFHLEdBQWMsRUFBRSxDQUFDO1FBQ3hCLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDdkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ1gsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsRUFBRTtZQUNaLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRTtnQkFDakIsSUFBSSxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRTtvQkFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFFLFVBQVU7b0JBQ3RDLFlBQVksRUFBRSxDQUFDO2lCQUNsQjtxQkFBTSxJQUFJLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksR0FBRyxFQUFFO29CQUM1QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUUsS0FBSztvQkFDakMsWUFBWSxFQUFFLENBQUM7aUJBQ2xCO3FCQUFNLElBQUksS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUU7b0JBQzVCLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBYyxLQUFLO2lCQUNwQztxQkFBTTtvQkFDSCxxQkFBcUI7b0JBQ3JCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBRSxLQUFLO29CQUNqQyxZQUFZLEVBQUUsQ0FBQztpQkFDbEI7Z0JBQ0QsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNWO2lCQUFNO2dCQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDVjtTQUNKO1FBQ0QsSUFBSSxZQUFZLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUM3QixPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7U0FDekU7UUFDRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDdkI7SUFDRCxPQUFPLGFBQWEsTUFBTyxDQUFDLElBQUksaUJBQWlCLEdBQUcsR0FBRyxDQUFBO0FBQzNELENBQUM7QUEzQ0QsOEJBMkNDO0FBRUQsU0FBZ0IsTUFBTSxDQUFDLEdBQVcsRUFBRSxJQUFzQztJQUN0RSxPQUFPLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLENBQUM7QUFDbkMsQ0FBQztBQUZELHdCQUVDO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsR0FBVztJQUN4QyxJQUFJLEdBQXVCLENBQUM7SUFDNUIsSUFBSSxNQUFNLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxFQUFFO1FBQzVCLEdBQUcsR0FBRyxhQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDN0I7U0FBTSxJQUFJLE1BQU0sQ0FBQyxHQUFHLEVBQUUsaUJBQWlCLENBQUMsRUFBRTtRQUN2QyxHQUFHLEdBQUcsaUJBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDakM7SUFDRCxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUM7QUFDdEIsQ0FBQztBQVJELDRDQVFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XG5jb25zdCBjZmdJbmZvID0gcmVxdWlyZShcIi4vc3RyaW5nc1wiKTtcblxuXG4vLyBjb25zdCBDT05GSUdGSUxFTkFNRSA9IFwic3RyaW5ncy5qc29uXCI7XG5jb25zdCBERUZBVUxUTEFOR1VBR0UgPSBcImVuXCI7XG5cbmludGVyZmFjZSBMb2NhbGVJbmZvIHtcbiAgICBsYW5nOiBzdHJpbmc7XG4gICAgZW5jb2Rpbmc/OiBzdHJpbmc7XG59XG5cbmxldCBsb2NhbGU6IExvY2FsZUluZm8gfCBudWxsID0gbnVsbDtcbmxldCBjdXJMYW5nU3RyaW5nOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9IHwgbnVsbCA9IG51bGw7XG5sZXQgZGVmYXVsdExhbmdTdHJpbmc6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gfCBudWxsID0gbnVsbDtcblxuZnVuY3Rpb24gZ2V0RW52TG9jYWxlKCk6IExvY2FsZUluZm8ge1xuICAgIGNvbnN0IGRlZmF1bHRSZXQgPSB7bGFuZzogXCJlblwifTtcbiAgICBsZXQgZW52ID0gcHJvY2Vzcy5lbnY7XG4gICAgbGV0IGxhbmdFbmNvZGluZyA9IGVudi5MQ0FMTCB8fCBlbnYuTENNRVNTQUdFUyB8fCBlbnYuTEFORyB8fCBlbnYuTEFOR1VBR0UgfHwgSW50bC5EYXRlVGltZUZvcm1hdCgpLnJlc29sdmVkT3B0aW9ucygpLmxvY2FsZTtcbiAgICBpZiAoIWxhbmdFbmNvZGluZykge1xuICAgICAgICByZXR1cm4gZGVmYXVsdFJldDtcbiAgICB9XG4gICAgbGV0IHAyID0gbGFuZ0VuY29kaW5nLnNwbGl0KFwiLlwiKTtcbiAgICByZXR1cm4ge2xhbmc6IHAyWzBdIHx8IGRlZmF1bHRSZXQubGFuZ307XG59XG5cbmZ1bmN0aW9uIGdldEF2YWlhYmxlTGFuZ3MoKTogc3RyaW5nW10ge1xuICAgIGlmICghIWNmZ0luZm8pIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGNmZ0luZm8pO1xuICAgIH1cbiAgICByZXR1cm4gW107XG59XG5cbmZ1bmN0aW9uIGdldExhbmdLZXkobGFuZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgcDIgPSBsYW5nLnNwbGl0KFwiX1wiKTtcbiAgICBpZiAocDJbMF0gPT0gXCJ6aFwiKVxuICAgICAgICByZXR1cm4gKHAyLmxlbmd0aCA9PSAxIHx8IHAyWzFdID09IFwiY25cIikgPyBcInpoXCIgOiBcInpoVHJcIjtcbiAgICByZXR1cm4gcDJbMF07XG59XG5cbmZ1bmN0aW9uIGRvSW5pdCgpIHtcbiAgICBsb2NhbGUgPSBnZXRFbnZMb2NhbGUoKTtcbiAgICBjdXJMYW5nU3RyaW5nID0gY2ZnSW5mb1tnZXRMYW5nS2V5KGxvY2FsZS5sYW5nKV07XG4gICAgaWYgKCFjdXJMYW5nU3RyaW5nKSB7XG4gICAgICAgIGN1ckxhbmdTdHJpbmcgPSBjZmdJbmZvW0RFRkFVTFRMQU5HVUFHRV07XG4gICAgfVxuICAgIGRlZmF1bHRMYW5nU3RyaW5nID0gY2ZnSW5mb1tERUZBVUxUTEFOR1VBR0VdO1xufVxuXG5kb0luaXQoKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNldEN1cnJlbnRMYW5ndWFnZShsYW5nOiBzdHJpbmcpIHtcbiAgICBsZXQgbGFuZ0tleSA9IGdldExhbmdLZXkobGFuZyk7XG4gICAgaWYgKGxhbmcgaW4gY2ZnSW5mbykge1xuICAgICAgICBjdXJMYW5nU3RyaW5nID0gY2ZnSW5mb1tsYW5nXTtcbiAgICAgICAgbG9jYWxlIS5sYW5nID0gbGFuZztcbiAgICB9IGVsc2UgaWYgKGxhbmdLZXkgaW4gY2ZnSW5mbykge1xuICAgICAgICBjdXJMYW5nU3RyaW5nID0gY2ZnSW5mb1tsYW5nS2V5XTtcbiAgICAgICAgbG9jYWxlIS5sYW5nID0gbGFuZ0tleTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oKVxuICAgIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RyaW5nKGtleTogc3RyaW5nLCAuLi5mbXRzOiAoc3RyaW5nIHwgbnVtYmVyKVtdKSB7XG4gICAgaWYgKGN1ckxhbmdTdHJpbmcpIHtcbiAgICAgICAgbGV0IGZtdCA9IGN1ckxhbmdTdHJpbmdba2V5XTtcbiAgICAgICAgaWYgKCFmbXQpIHtcbiAgICAgICAgICAgIHJldHVybiBgW0tFWSBcIiR7a2V5fVwiIGlzIG5vdCBmb3VuZCEgbGFuZzogJHtsb2NhbGUhLmxhbmd9XWBcbiAgICAgICAgfVxuICAgICAgICBpZiAoZm10cy5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIGZtdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjaGFycyA9IEFycmF5LmZyb20oZm10KTtcbiAgICAgICAgbGV0IHJldDogc3RyaW5nIFtdID0gW107XG4gICAgICAgIGxldCBsZW4gPSBjaGFycy5sZW5ndGg7XG4gICAgICAgIGxldCBwID0gMDtcbiAgICAgICAgbGV0IGFpID0gMDtcbiAgICAgICAgbGV0IHBsYWNlSG9sZGVycyA9IDA7XG4gICAgICAgIHdoaWxlIChwIDwgbGVuKSB7XG4gICAgICAgICAgICBpZiAoY2hhcnNbcF0gPT0gXCIlXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hhcnNbcCArIDFdID09IFwiZFwiIHx8IGNoYXJzW3AgKyAxXSA9PSBcImZcIikge1xuICAgICAgICAgICAgICAgICAgICByZXQucHVzaChmbXRzW2FpKytdICsgXCJcIik7ICAvLyAlZCB8ICVmXG4gICAgICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVycysrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhcnNbcCArIDFdID09IFwic1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGZtdHNbYWkrK10gKyBcIlwiKTsgIC8vICVzXG4gICAgICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVycysrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhcnNbcCArIDFdID09IFwiJVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKFwiJVwiKTsgICAgICAgICAgICAgIC8vICUlXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdW5rbm93biBmb3JtYXR0ZXI/XG4gICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKGZtdHNbYWkrK10gKyBcIlwiKTsgIC8vICU/XG4gICAgICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVycysrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwICs9IDI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKGNoYXJzW3BdKTtcbiAgICAgICAgICAgICAgICBwICs9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBsYWNlSG9sZGVycyAhPSBmbXRzLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZm9ybWF0IGFyZ3VtZW50IG1pc21hdGNoOiAke2ZtdH0gJiAke2ZtdHMuam9pbihcIiwgXCIpfWApXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldC5qb2luKFwiXCIpO1xuICAgIH1cbiAgICByZXR1cm4gYFtsYW5ndWFnZSAke2xvY2FsZSEubGFuZ30gbm90IHNldCwga2V5ICR7a2V5fV1gXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNLZXkoa2V5OiBzdHJpbmcsIGRhdGE6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gfCBudWxsKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhZGF0YSAmJiAoa2V5IGluIGRhdGEpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VycmVudFN0cmluZyhrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IHJldDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmIChoYXNLZXkoa2V5LCBjdXJMYW5nU3RyaW5nKSkge1xuICAgICAgICByZXQgPSBjdXJMYW5nU3RyaW5nIVtrZXldO1xuICAgIH0gZWxzZSBpZiAoaGFzS2V5KGtleSwgZGVmYXVsdExhbmdTdHJpbmcpKSB7XG4gICAgICAgIHJldCA9IGRlZmF1bHRMYW5nU3RyaW5nIVtrZXldO1xuICAgIH1cbiAgICByZXR1cm4gcmV0IHx8IGtleTtcbn1cbiJdfQ==