'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.close = exports.ready = exports.methods = exports.$ = exports.template = exports.style = void 0;
const path_1 = require("path");
const fs_1 = require("fs");
const { I18n, Message, Dialog, Profile } = Editor;
exports.style = fs_1.readFileSync(path_1.join(__dirname, '../../dist/index.css'), 'utf8');
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../statics/index.html'), 'utf8');
let ui_editor;
let ui_images;
let ui_x;
let ui_y;
let ui_opacity;
let btn_add;
let btn_del;
exports.$ = {
    ui_editor: '.config',
    ui_images: '.images',
    btnAdd: '.add-image',
    btnDel: '.del-image',
    x: '.x',
    y: '.y',
    opacity: '.opacity'
};
let images = [];
let index = 0;
let x = 0;
let y = 0;
let opacity = 0;
let show = true;
let onAddImageFunc;
let onDelImageFunc;
let onSetOpacityFunc;
let onSwitchImagesFunc;
exports.methods = {
    async 'scene:ready'() {
        this.sendSwitchImages();
        Message.broadcast('reference-image:show', show);
    },
    async updateImages() {
        // @ts-ignore
        const panel = this;
        // clear
        while (ui_images.firstChild) {
            ui_images.removeChild(ui_images.firstChild);
        }
        for (let i = 0; i < images.length; ++i) {
            const option = document.createElement('option');
            option.setAttribute('value', `${i}`);
            ui_images.appendChild(option);
            const path = images[i];
            option.text = path_1.basename(path, path_1.extname(path));
        }
        btn_del.removeAttribute('disabled');
        ui_editor.removeAttribute('disabled');
        ui_images.removeAttribute('placeholder');
        ui_images.setAttribute('value', '');
        if (images.length === 0) {
            ui_images.setAttribute('placeholder', I18n.t('reference-image.none'));
            btn_del.setAttribute('disabled', '');
            ui_editor.setAttribute('disabled', '');
            await this.resetImage();
        }
        else {
            ui_images.setAttribute('value', `${index}`);
            await this.sendSwitchImages();
        }
    },
    async onAddImage() {
        const result = await Dialog.select({
            title: I18n.t('reference-image.dialog.add-image-title'),
            path: await Profile.getConfig('reference-image', 'root-path') || '',
            filters: [{ name: 'image', extensions: ['png', 'jpg'] }],
        });
        if (!result || !result.filePaths[0]) {
            return;
        }
        for (let path of result.filePaths) {
            if (!images.includes(path)) {
                images.push(path);
            }
        }
        index = images.length - 1;
        await this.updateImages();
        const path = path_1.dirname(result.filePaths[0]);
        await Profile.setConfig('reference-image', 'root-path', path);
    },
    async onDelImage() {
        const result = await Dialog.info(I18n.t('reference-image.dialog.del_image_message', {
            path: images[index]
        }), {
            buttons: [
                I18n.t('reference-image.dialog.yes'),
                I18n.t('reference-image.dialog.cancel'),
            ],
            default: 0,
            cancel: 1,
        });
        if (result.response === 0) {
            images.splice(index, 1);
            index--;
            if (index < 0) {
                index = 0;
            }
            await this.updateImages();
        }
    },
    async resetImage() {
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'resetImage',
        });
    },
    async sendSwitchImages() {
        const path = images[index];
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'switchImages',
            args: [path],
        });
        this.sendMoveX();
        this.sendMoveY();
        this.sendOpacity();
    },
    async onSwitchImages(event) {
        // @ts-ignore
        index = parseInt(event.target.value);
        await this.sendSwitchImages();
    },
    async sendOpacity() {
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'setOpacity',
            args: [opacity],
        });
    },
    async sendMoveX() {
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'moveX',
            args: [x],
        });
    },
    async sendMoveY() {
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'moveY',
            args: [y],
        });
    },
    async onMoveX(event) {
        // @ts-ignore
        x = event.target.value;
        await Profile.setConfig('reference-image', 'x', x);
        await this.sendMoveX();
    },
    async onMoveY(event) {
        // @ts-ignore
        y = event.target.value;
        await Profile.setConfig('reference-image', 'y', y);
        await this.sendMoveY();
    },
    async onSetOpacity(event) {
        // @ts-ignore
        opacity = event.target.value;
        await Profile.setConfig('reference-image', 'opacity', opacity);
        await this.sendOpacity();
    },
    registerEventListeners() {
        // @ts-ignore
        ui_x.addEventListener('confirm', this.onMoveX);
        ui_y.addEventListener('confirm', this.onMoveY);
        onSetOpacityFunc = this.onSetOpacity.bind(this);
        ui_opacity.addEventListener('confirm', onSetOpacityFunc);
        onSwitchImagesFunc = this.onSwitchImages.bind(this);
        ui_images.addEventListener('confirm', onSwitchImagesFunc);
        onAddImageFunc = this.onAddImage.bind(this);
        btn_add.addEventListener('click', onAddImageFunc);
        onDelImageFunc = this.onDelImage.bind(this);
        btn_del.addEventListener('click', onDelImageFunc);
    },
    unregisterEventListeners() {
        // @ts-ignore
        ui_x.removeEventListener('confirm', this.onMoveX);
        ui_y.removeEventListener('confirm', this.onMoveY);
        ui_opacity.removeEventListener('confirm', onSetOpacityFunc);
        ui_images.removeEventListener('confirm', onSwitchImagesFunc);
        btn_add.removeEventListener('click', onAddImageFunc);
        btn_del.removeEventListener('click', onDelImageFunc);
    }
};
exports.ready = async function () {
    // @ts-ignore
    const panel = this;
    ui_x = panel.$.x;
    ui_y = panel.$.y;
    ui_editor = panel.$.ui_editor;
    ui_images = panel.$.ui_images;
    ui_opacity = panel.$.opacity;
    btn_add = panel.$.btnAdd;
    btn_del = panel.$.btnDel;
    panel.registerEventListeners();
    x = await Profile.getConfig('reference-image', 'x') || 0;
    y = await Profile.getConfig('reference-image', 'y') || 0;
    opacity = await Profile.getConfig('reference-image', 'opacity') || 100;
    index = await Profile.getConfig('reference-image', 'index') || index;
    images = await Profile.getConfig('reference-image', 'images') || [];
    ui_x.value = x;
    ui_y.value = y;
    ui_opacity.value = opacity;
    ui_images.value = index;
    await panel.updateImages();
    show = await Profile.getConfig('reference-image', 'show');
    Message.broadcast('reference-image:show', show);
};
exports.close = async function () {
    // @ts-ignore
    const panel = this;
    panel.unregisterEventListeners();
    await Profile.setConfig('reference-image', 'images', images);
    await Profile.setConfig('reference-image', 'index', index);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvcGFuZWwvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYiwrQkFBd0Q7QUFDeEQsMkJBQWtDO0FBRWxDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxNQUFNLENBQUM7QUFFckMsUUFBQSxLQUFLLEdBQUcsaUJBQVksQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLHNCQUFzQixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdEUsUUFBQSxRQUFRLEdBQUcsaUJBQVksQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLDBCQUEwQixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFMUYsSUFBSSxTQUFzQixDQUFDO0FBQzNCLElBQUksU0FBc0IsQ0FBQztBQUMzQixJQUFJLElBQWlCLENBQUM7QUFDdEIsSUFBSSxJQUFpQixDQUFDO0FBQ3RCLElBQUksVUFBdUIsQ0FBQztBQUM1QixJQUFJLE9BQW9CLENBQUM7QUFDekIsSUFBSSxPQUFvQixDQUFDO0FBQ1osUUFBQSxDQUFDLEdBQUc7SUFDYixTQUFTLEVBQUUsU0FBUztJQUNwQixTQUFTLEVBQUUsU0FBUztJQUNwQixNQUFNLEVBQUUsWUFBWTtJQUNwQixNQUFNLEVBQUUsWUFBWTtJQUVwQixDQUFDLEVBQUUsSUFBSTtJQUNQLENBQUMsRUFBRSxJQUFJO0lBQ1AsT0FBTyxFQUFFLFVBQVU7Q0FDdEIsQ0FBQztBQUVGLElBQUksTUFBTSxHQUFhLEVBQUUsQ0FBQztBQUMxQixJQUFJLEtBQUssR0FBVyxDQUFDLENBQUM7QUFDdEIsSUFBSSxDQUFDLEdBQVcsQ0FBQyxDQUFDO0FBQ2xCLElBQUksQ0FBQyxHQUFXLENBQUMsQ0FBQztBQUNsQixJQUFJLE9BQU8sR0FBVyxDQUFDLENBQUM7QUFDeEIsSUFBSSxJQUFJLEdBQUcsSUFB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QVksRUFBRSxDQUFDO0lBRTNCLElBQUksR0FBRyxNQUFNLE9BQU8sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDMUQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNwRCxDQUFDLENBQUM7QUFFVyxRQUFBLEtBQUssR0FBRyxLQUFLO0lBQ3RCLGFBQWE7SUFDYixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDbkIsS0FBSyxDQUFDLHdCQUF3QixFQUFFLENBQUM7SUFDakMsTUFBTSxPQUFPLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM3RCxNQUFNLE9BQU8sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQy9ELENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgZGlybmFtZSwgYmFzZW5hbWUsIGV4dG5hbWUsIGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gXCJmc1wiO1xuXG5jb25zdCB7IEkxOG4sIE1lc3NhZ2UsIERpYWxvZywgUHJvZmlsZSB9ID0gRWRpdG9yO1xuXG5leHBvcnQgY29uc3Qgc3R5bGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9kaXN0L2luZGV4LmNzcycpLCAndXRmOCcpO1xuZXhwb3J0IGNvbnN0IHRlbXBsYXRlID0gcmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCAnLi4vLi4vc3RhdGljcy9pbmRleC5odG1sJyksICd1dGY4Jyk7XG5cbmxldCB1aV9lZGl0b3I6IEhUTUxFbGVtZW50O1xubGV0IHVpX2ltYWdlczogSFRNTEVsZW1lbnQ7XG5sZXQgdWlfeDogSFRNTEVsZW1lbnQ7XG5sZXQgdWlfeTogSFRNTEVsZW1lbnQ7XG5sZXQgdWlfb3BhY2l0eTogSFRNTEVsZW1lbnQ7XG5sZXQgYnRuX2FkZDogSFRNTEVsZW1lbnQ7XG5sZXQgYnRuX2RlbDogSFRNTEVsZW1lbnQ7XG5leHBvcnQgY29uc3QgJCA9IHtcbiAgICB1aV9lZGl0b3I6ICcuY29uZmlnJyxcbiAgICB1aV9pbWFnZXM6ICcuaW1hZ2VzJyxcbiAgICBidG5BZGQ6ICcuYWRkLWltYWdlJyxcbiAgICBidG5EZWw6ICcuZGVsLWltYWdlJyxcblxuICAgIHg6ICcueCcsXG4gICAgeTogJy55JyxcbiAgICBvcGFjaXR5OiAnLm9wYWNpdHknXG59O1xuXG5sZXQgaW1hZ2VzOiBzdHJpbmdbXSA9IFtdO1xubGV0IGluZGV4OiBudW1iZXIgPSAwO1xubGV0IHg6IG51bWJlciA9IDA7XG5sZXQgeTogbnVtYmVyID0gMDtcbmxldCBvcGFjaXR5OiBudW1iZXIgPSAwO1xubGV0IHNob3cgPSB0cnVlO1xuXG5sZXQgb25BZGRJbWFnZUZ1bmM7XG5sZXQgb25EZWxJbWFnZUZ1bmM7XG5sZXQgb25TZXRPcGFjaXR5RnVuYztcbmxldCBvblN3aXRjaEltYWdlc0Z1bmM7XG5leHBvcnQgY29uc3QgbWV0aG9kcyA9IHtcblxuICAgIGFzeW5jICdzY2VuZTpyZWFkeScoKSB7XG4gICAgICAgIHRoaXMuc2VuZFN3aXRjaEltYWdlcygpO1xuICAgICAgICBNZXNzYWdlLmJyb2FkY2FzdCgncmVmZXJlbmNlLWltYWdlOnNob3cnLCBzaG93KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgdXBkYXRlSW1hZ2VzKCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHBhbmVsID0gdGhpcztcbiAgICAgICAgLy8gY2xlYXJcbiAgICAgICAgd2hpbGUgKCB1aV9pbWFnZXMuZmlyc3RDaGlsZCApIHtcbiAgICAgICAgICAgIHVpX2ltYWdlcy5yZW1vdmVDaGlsZCh1aV9pbWFnZXMuZmlyc3RDaGlsZCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbWFnZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xuICAgICAgICAgICAgb3B0aW9uLnNldEF0dHJpYnV0ZSgndmFsdWUnLCBgJHtpfWApO1xuICAgICAgICAgICAgdWlfaW1hZ2VzLmFwcGVuZENoaWxkKG9wdGlvbik7XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gaW1hZ2VzW2ldO1xuICAgICAgICAgICAgb3B0aW9uLnRleHQgPSBiYXNlbmFtZShwYXRoLCBleHRuYW1lKHBhdGgpKTtcbiAgICAgICAgfVxuICAgICAgICBidG5fZGVsLnJlbW92ZUF0dHJpYnV0ZSgnZGlzYWJsZWQnKTtcbiAgICAgICAgdWlfZWRpdG9yLnJlbW92ZUF0dHJpYnV0ZSgnZGlzYWJsZWQnKTtcbiAgICAgICAgdWlfaW1hZ2VzLnJlbW92ZUF0dHJpYnV0ZSgncGxhY2Vob2xkZXInKTtcbiAgICAgICAgdWlfaW1hZ2VzLnNldEF0dHJpYnV0ZSgndmFsdWUnLCAnJyk7XG4gICAgICAgIGlmIChpbWFnZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB1aV9pbWFnZXMuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsIEkxOG4udCgncmVmZXJlbmNlLWltYWdlLm5vbmUnKSk7XG4gICAgICAgICAgICBidG5fZGVsLnNldEF0dHJpYnV0ZSgnZGlzYWJsZWQnLCAnJyk7XG4gICAgICAgICAgICB1aV9lZGl0b3Iuc2V0QXR0cmlidXRlKCdkaXNhYmxlZCcsICcnKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucmVzZXRJbWFnZSgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdWlfaW1hZ2VzLnNldEF0dHJpYnV0ZSgndmFsdWUnLCBgJHtpbmRleH1gKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VuZFN3aXRjaEltYWdlcygpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIGFzeW5jIG9uQWRkSW1hZ2UoKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERpYWxvZy5zZWxlY3Qoe1xuICAgICAgICAgICAgdGl0bGU6IEkxOG4udCgncmVmZXJlbmNlLWltYWdlLmRpYWxvZy5hZGQtaW1hZ2UtdGl0bGUnKSxcbiAgICAgICAgICAgIHBhdGg6IGF3YWl0IFByb2ZpbGUuZ2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAncm9vdC1wYXRoJykgfHwgJycsXG4gICAgICAgICAgICBmaWx0ZXJzOiBbeyBuYW1lOiAnaW1hZ2UnLCBleHRlbnNpb25zOiBbJ3BuZycsICdqcGcnXSB9XSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghcmVzdWx0IHx8ICFyZXN1bHQuZmlsZVBhdGhzWzBdKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgcGF0aCBvZiByZXN1bHQuZmlsZVBhdGhzKSB7XG4gICAgICAgICAgICBpZiAoIWltYWdlcy5pbmNsdWRlcyhwYXRoKSkge1xuICAgICAgICAgICAgICAgIGltYWdlcy5wdXNoKHBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGluZGV4ID0gaW1hZ2VzLmxlbmd0aCAtIDE7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW1hZ2VzKCk7XG4gICAgICAgIGNvbnN0IHBhdGggPSBkaXJuYW1lKHJlc3VsdC5maWxlUGF0aHNbMF0pO1xuICAgICAgICBhd2FpdCBQcm9maWxlLnNldENvbmZpZygncmVmZXJlbmNlLWltYWdlJywgJ3Jvb3QtcGF0aCcsIHBhdGgpO1xuICAgIH0sXG5cbiAgICBhc3luYyBvbkRlbEltYWdlKCkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBEaWFsb2cuaW5mbyhJMThuLnQoJ3JlZmVyZW5jZS1pbWFnZS5kaWFsb2cuZGVsX2ltYWdlX21lc3NhZ2UnLCB7XG4gICAgICAgICAgICBwYXRoOiBpbWFnZXNbaW5kZXhdXG4gICAgICAgIH0pLCB7XG4gICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgSTE4bi50KCdyZWZlcmVuY2UtaW1hZ2UuZGlhbG9nLnllcycpLFxuICAgICAgICAgICAgICAgIEkxOG4udCgncmVmZXJlbmNlLWltYWdlLmRpYWxvZy5jYW5jZWwnKSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBkZWZhdWx0OiAwLFxuICAgICAgICAgICAgY2FuY2VsOiAxLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHJlc3VsdC5yZXNwb25zZSA9PT0gMCkge1xuICAgICAgICAgICAgaW1hZ2VzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICBpbmRleC0tO1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW1hZ2VzKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgYXN5bmMgcmVzZXRJbWFnZSgpIHtcbiAgICAgICAgYXdhaXQgTWVzc2FnZS5yZXF1ZXN0KCdzY2VuZScsICdleGVjdXRlLXNjZW5lLXNjcmlwdCcsIHtcbiAgICAgICAgICAgIG5hbWU6ICdyZWZlcmVuY2UtaW1hZ2UnLFxuICAgICAgICAgICAgbWV0aG9kOiAncmVzZXRJbWFnZScsXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBhc3luYyBzZW5kU3dpdGNoSW1hZ2VzKCkge1xuICAgICAgICBjb25zdCBwYXRoOiBzdHJpbmcgPSBpbWFnZXNbaW5kZXhdO1xuICAgICAgICBhd2FpdCBNZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICAgICAgbmFtZTogJ3JlZmVyZW5jZS1pbWFnZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdzd2l0Y2hJbWFnZXMnLFxuICAgICAgICAgICAgYXJnczogWyBwYXRoIF0sXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNlbmRNb3ZlWCgpO1xuICAgICAgICB0aGlzLnNlbmRNb3ZlWSgpO1xuICAgICAgICB0aGlzLnNlbmRPcGFjaXR5KCk7XG4gICAgfSxcblxuICAgIGFzeW5jIG9uU3dpdGNoSW1hZ2VzKGV2ZW50OiBFdmVudCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGluZGV4ID0gcGFyc2VJbnQoZXZlbnQudGFyZ2V0LnZhbHVlKTtcbiAgICAgICAgYXdhaXQgdGhpcy5zZW5kU3dpdGNoSW1hZ2VzKCk7XG4gICAgfSxcblxuICAgIGFzeW5jIHNlbmRPcGFjaXR5KCkge1xuICAgICAgICBhd2FpdCBNZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICAgICAgbmFtZTogJ3JlZmVyZW5jZS1pbWFnZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdzZXRPcGFjaXR5JyxcbiAgICAgICAgICAgIGFyZ3M6IFsgb3BhY2l0eSBdLFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgc2VuZE1vdmVYKCkge1xuICAgICAgICBhd2FpdCBNZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICAgICAgbmFtZTogJ3JlZmVyZW5jZS1pbWFnZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdtb3ZlWCcsXG4gICAgICAgICAgICBhcmdzOiBbIHggXSxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIGFzeW5jIHNlbmRNb3ZlWSgpIHtcbiAgICAgICAgYXdhaXQgTWVzc2FnZS5yZXF1ZXN0KCdzY2VuZScsICdleGVjdXRlLXNjZW5lLXNjcmlwdCcsIHtcbiAgICAgICAgICAgIG5hbWU6ICdyZWZlcmVuY2UtaW1hZ2UnLFxuICAgICAgICAgICAgbWV0aG9kOiAnbW92ZVknLFxuICAgICAgICAgICAgYXJnczogWyB5IF0sXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBhc3luYyBvbk1vdmVYKGV2ZW50OiBFdmVudCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHggPSBldmVudC50YXJnZXQudmFsdWU7XG4gICAgICAgIGF3YWl0IFByb2ZpbGUuc2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAneCcsIHgpO1xuICAgICAgICBhd2FpdCB0aGlzLnNlbmRNb3ZlWCgpO1xuICAgIH0sXG5cbiAgICBhc3luYyBvbk1vdmVZKGV2ZW50OiBFdmVudCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHkgPSBldmVudC50YXJnZXQudmFsdWU7XG4gICAgICAgIGF3YWl0IFByb2ZpbGUuc2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAneScsIHkpO1xuICAgICAgICBhd2FpdCB0aGlzLnNlbmRNb3ZlWSgpO1xuICAgIH0sXG5cbiAgICBhc3luYyBvblNldE9wYWNpdHkoZXZlbnQ6IEV2ZW50KSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgb3BhY2l0eSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgICAgICAgYXdhaXQgUHJvZmlsZS5zZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICdvcGFjaXR5Jywgb3BhY2l0eSk7XG4gICAgICAgIGF3YWl0IHRoaXMuc2VuZE9wYWNpdHkoKTtcbiAgICB9LFxuXG4gICAgcmVnaXN0ZXJFdmVudExpc3RlbmVycygpIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICB1aV94LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbmZpcm0nLCB0aGlzLm9uTW92ZVgpO1xuICAgICAgICB1aV95LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbmZpcm0nLCB0aGlzLm9uTW92ZVkpO1xuICAgICAgICBvblNldE9wYWNpdHlGdW5jID0gdGhpcy5vblNldE9wYWNpdHkuYmluZCh0aGlzKTtcbiAgICAgICAgdWlfb3BhY2l0eS5hZGRFdmVudExpc3RlbmVyKCdjb25maXJtJywgb25TZXRPcGFjaXR5RnVuYyk7XG4gICAgICAgIG9uU3dpdGNoSW1hZ2VzRnVuYyA9IHRoaXMub25Td2l0Y2hJbWFnZXMuYmluZCh0aGlzKTtcbiAgICAgICAgdWlfaW1hZ2VzLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbmZpcm0nLCBvblN3aXRjaEltYWdlc0Z1bmMpO1xuICAgICAgICBvbkFkZEltYWdlRnVuYyA9IHRoaXMub25BZGRJbWFnZS5iaW5kKHRoaXMpO1xuICAgICAgICBidG5fYWRkLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgb25BZGRJbWFnZUZ1bmMpO1xuICAgICAgICBvbkRlbEltYWdlRnVuYyA9IHRoaXMub25EZWxJbWFnZS5iaW5kKHRoaXMpO1xuICAgICAgICBidG5fZGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgb25EZWxJbWFnZUZ1bmMpO1xuICAgIH0sXG5cbiAgICB1bnJlZ2lzdGVyRXZlbnRMaXN0ZW5lcnMoKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdWlfeC5yZW1vdmVFdmVudExpc3RlbmVyKCdjb25maXJtJywgdGhpcy5vbk1vdmVYKTtcbiAgICAgICAgdWlfeS5yZW1vdmVFdmVudExpc3RlbmVyKCdjb25maXJtJywgdGhpcy5vbk1vdmVZKTtcbiAgICAgICAgdWlfb3BhY2l0eS5yZW1vdmVFdmVudExpc3RlbmVyKCdjb25maXJtJywgb25TZXRPcGFjaXR5RnVuYyk7XG4gICAgICAgIHVpX2ltYWdlcy5yZW1vdmVFdmVudExpc3RlbmVyKCdjb25maXJtJywgb25Td2l0Y2hJbWFnZXNGdW5jKTtcbiAgICAgICAgYnRuX2FkZC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIG9uQWRkSW1hZ2VGdW5jKTtcbiAgICAgICAgYnRuX2RlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIG9uRGVsSW1hZ2VGdW5jKTtcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3QgcmVhZHkgPSBhc3luYyBmdW5jdGlvbigpIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgcGFuZWwgPSB0aGlzO1xuXG4gICAgdWlfeCA9IHBhbmVsLiQueDtcbiAgICB1aV95ID0gcGFuZWwuJC55O1xuICAgIHVpX2VkaXRvciA9IHBhbmVsLiQudWlfZWRpdG9yO1xuICAgIHVpX2ltYWdlcyA9IHBhbmVsLiQudWlfaW1hZ2VzO1xuICAgIHVpX29wYWNpdHkgPSBwYW5lbC4kLm9wYWNpdHk7XG4gICAgYnRuX2FkZCA9IHBhbmVsLiQuYnRuQWRkO1xuICAgIGJ0bl9kZWwgPSBwYW5lbC4kLmJ0bkRlbDtcblxuICAgIHBhbmVsLnJlZ2lzdGVyRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICB4ID0gYXdhaXQgUHJvZmlsZS5nZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICd4JykgfHwgMDtcbiAgICB5ID0gYXdhaXQgUHJvZmlsZS5nZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICd5JykgfHwgMDtcbiAgICBvcGFjaXR5ID0gYXdhaXQgUHJvZmlsZS5nZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICdvcGFjaXR5JykgfHwgMTAwO1xuICAgIGluZGV4ID0gYXdhaXQgUHJvZmlsZS5nZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICdpbmRleCcpIHx8IGluZGV4O1xuICAgIGltYWdlcyA9IGF3YWl0IFByb2ZpbGUuZ2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAnaW1hZ2VzJykgfHwgW107XG5cbiAgICB1aV94LnZhbHVlID0geDtcbiAgICB1aV95LnZhbHVlID0geTtcbiAgICB1aV9vcGFjaXR5LnZhbHVlID0gb3BhY2l0eTtcbiAgICB1aV9pbWFnZXMudmFsdWUgPSBpbmRleDtcbiAgICBhd2FpdCBwYW5lbC51cGRhdGVJbWFnZXMoKTtcblxuICAgIHNob3cgPSBhd2FpdCBQcm9maWxlLmdldENvbmZpZygncmVmZXJlbmNlLWltYWdlJywgJ3Nob3cnKTtcbiAgICBNZXNzYWdlLmJyb2FkY2FzdCgncmVmZXJlbmNlLWltYWdlOnNob3cnLCBzaG93KTtcbn07XG5cbmV4cG9ydCBjb25zdCBjbG9zZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgcGFuZWwgPSB0aGlzO1xuICAgIHBhbmVsLnVucmVnaXN0ZXJFdmVudExpc3RlbmVycygpO1xuICAgIGF3YWl0IFByb2ZpbGUuc2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAnaW1hZ2VzJywgaW1hZ2VzKTtcbiAgICBhd2FpdCBQcm9maWxlLnNldENvbmZpZygncmVmZXJlbmNlLWltYWdlJywgJ2luZGV4JywgaW5kZXgpO1xufTtcbiJdfQ==