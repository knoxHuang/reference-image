'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.close = exports.ready = exports.methods = exports.$ = exports.template = exports.style = void 0;
const path_1 = require("path");
const fs_1 = require("fs");
const { I18n, Message, Dialog, Profile } = Editor;
exports.style = fs_1.readFileSync(path_1.join(__dirname, '../../dist/index.css'), 'utf8');
exports.template = fs_1.readFileSync(path_1.join(__dirname, '../../../static/index.html'), 'utf8');
exports.$ = {
    ui_images: '.images',
    btnAdd: '.add-images',
    btnDel: '.del-images',
    x: '.x',
    y: '.y',
    opacity: '.opacity'
};
let images = [];
let index = 0;
exports.methods = {
    updateImages() {
        // @ts-ignore
        const panel = this;
        // @ts-ignore
        const ui_images = panel.$.ui_images;
        // clear
        while (ui_images.firstChild) {
            ui_images.removeChild(ui_images.firstChild);
        }
        for (let i = 0; i < images.length; ++i) {
            const path = images[i];
            const option = document.createElement('div');
            option.innerHTML = `<option value=${i}>${path_1.basename(path, path_1.extname(path))}</option>`;
            ui_images.appendChild(option);
        }
        ui_images.setAttribute('value', `${index}`);
    },
    async onAddImage() {
        const result = await Dialog.select({
            title: I18n.t('reference-image.dialog.add-image-title'),
            path: await Profile.getConfig('reference-image', 'root-path') || '',
            filters: [{ name: 'image', extensions: ['png', 'jpg'] }],
        });
        if (!result || !result.filePaths[0]) {
            return;
        }
        images = images.concat(result.filePaths);
        this.updateImages();
        const path = path_1.dirname(result.filePaths[0]);
        await Profile.setConfig('reference-image', 'root-path', path);
    },
    async onDelImage() {
        const result = await Dialog.info(I18n.t('reference-image.dialog.del_image_message'), {
            buttons: [
                I18n.t('reference-image.dialog.yes'),
                I18n.t('reference-image.dialog.cancel'),
            ],
            default: 0,
            cancel: 1,
        });
        if (result.response === 0) {
            images.splice(index, 1);
            index--;
            if (index < 0) {
                index = 0;
            }
            this.updateImages();
        }
    },
    async switchImages(path) {
        debugger;
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'switchImages',
            args: [path],
        });
    },
    async onMoveX(event) {
        // @ts-ignore
        const x = event.target.value;
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'moveX',
            args: [x],
        });
        await Profile.setConfig('reference-image', 'x', x);
    },
    async onMoveY(event) {
        // @ts-ignore
        const y = event.target.value;
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'moveY',
            args: [y],
        });
        await Profile.setConfig('reference-image', 'y', y);
    },
    async onSetOpacity(event) {
        // @ts-ignore
        const opacity = event.target.value;
        await Message.request('scene', 'execute-scene-script', {
            name: 'reference-image',
            method: 'setOpacity',
            args: [opacity],
        });
        await Profile.setConfig('reference-image', 'opacity', opacity);
    },
    registerEventListeners() {
        // @ts-ignore
        const $ = this.$;
        $.x.addEventListener('confirm', this.onMoveX);
        $.y.addEventListener('confirm', this.onMoveY);
        $.opacity.addEventListener('confirm', this.onSetOpacity);
        $.ui_images.addEventListener('confirm', this.switchImages);
        $.btnAdd.addEventListener('click', this.onAddImage);
        $.btnDel.addEventListener('click', this.onDelImage);
    },
    unregisterEventListeners() {
        // @ts-ignore
        const $ = this.$;
        $.x.removeEventListener('confirm', this.onMoveX);
        $.y.removeEventListener('confirm', this.onMoveY);
        $.opacity.removeEventListener('confirm', this.onSetOpacity);
        $.ui_images.removeEventListener('confirm', this.switchImages);
        $.btnAdd.removeEventListener('click', this.onAddImage);
        $.btnDel.removeEventListener('click', this.onDelImage);
    }
};
exports.ready = async function () {
    // @ts-ignore
    const panel = this;
    panel.registerEventListeners();
    panel.$.x.value = await Profile.getConfig('reference-image', 'x') || 0;
    panel.$.y.value = await Profile.getConfig('reference-image', 'y');
    panel.$.opacity.value = await Profile.getConfig('reference-image', 'opacity');
    index = await Profile.getConfig('reference-image', 'index') || index;
    panel.$.ui_images.value = index;
    images = await Profile.getConfig('reference-image', 'images');
    panel.updateImages();
};
exports.close = async function () {
    // @ts-ignore
    const panel = this;
    panel.unregisterEventListeners();
    await Profile.setConfig('reference-image', 'images', images);
    await Profile.setConfig('reference-image', 'index', index);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvcGFuZWwvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYiwrQkFBd0Q7QUFDeEQsMkJBQWtDO0FBRWxDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxNQUFNLENBQUM7QUFFckMsUUFBQSxLQUFLLEdBQUcsaUJBQVksQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLHNCQUFzQixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdEUsUUFBQSxRQUFRLEdBQUcsaUJBQVksQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLDRCQUE0QixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFL0UsUUFBQSxDQUFDLEdBQUc7SUFDYixTQUFTLEVBQUUsU0FBUztJQUNwQixNQUFNLEVBQUUsYUFBYTtJQUNyQixNQUFNLEVBQUUsYUFBYTtJQUVyQixDQUFDLEVBQUUsSUFBSTtJQUNQLENBQUMsRUFBRSxJQUFJO0lBQ1AsT0FBTyxFQUFFLFVBQVU7Q0FDdEIsQ0FBQztBQUVGLElBQUksTUFBTSxHQUFhLEVBQUUsQ0FBQztBQUMxQixJQUFJLEtBQUssR0FBVyxDQUFDLENBQUM7QUFDVCxRQUFBLE9BQU8sR0FBRztJQUVuQixZQUFZO1FBQ1IsYUFBYTtRQUNiLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQztRQUNuQixhQUFhO1FBQ2IsTUFBTSxTQUFTLEdBQWdCLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2pELFFBQVE7UUFDUixPQUFRLFNBQVMsQ0FBQyxVQUFVLEVBQUc7WUFDM0IsU0FBUyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDL0M7UUFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0s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InNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgZGlybmFtZSwgYmFzZW5hbWUsIGV4dG5hbWUsIGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gXCJmc1wiO1xuXG5jb25zdCB7IEkxOG4sIE1lc3NhZ2UsIERpYWxvZywgUHJvZmlsZSB9ID0gRWRpdG9yO1xuXG5leHBvcnQgY29uc3Qgc3R5bGUgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi8uLi9kaXN0L2luZGV4LmNzcycpLCAndXRmOCcpO1xuZXhwb3J0IGNvbnN0IHRlbXBsYXRlID0gcmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCAnLi4vLi4vLi4vc3RhdGljL2luZGV4Lmh0bWwnKSwgJ3V0ZjgnKTtcblxuZXhwb3J0IGNvbnN0ICQgPSB7XG4gICAgdWlfaW1hZ2VzOiAnLmltYWdlcycsXG4gICAgYnRuQWRkOiAnLmFkZC1pbWFnZXMnLFxuICAgIGJ0bkRlbDogJy5kZWwtaW1hZ2VzJyxcblxuICAgIHg6ICcueCcsXG4gICAgeTogJy55JyxcbiAgICBvcGFjaXR5OiAnLm9wYWNpdHknXG59O1xuXG5sZXQgaW1hZ2VzOiBzdHJpbmdbXSA9IFtdO1xubGV0IGluZGV4OiBudW1iZXIgPSAwO1xuZXhwb3J0IGNvbnN0IG1ldGhvZHMgPSB7XG5cbiAgICB1cGRhdGVJbWFnZXMoKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgcGFuZWwgPSB0aGlzO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHVpX2ltYWdlczogSFRNTEVsZW1lbnQgPSBwYW5lbC4kLnVpX2ltYWdlcztcbiAgICAgICAgLy8gY2xlYXJcbiAgICAgICAgd2hpbGUgKCB1aV9pbWFnZXMuZmlyc3RDaGlsZCApIHtcbiAgICAgICAgICAgIHVpX2ltYWdlcy5yZW1vdmVDaGlsZCh1aV9pbWFnZXMuZmlyc3RDaGlsZCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbWFnZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBpbWFnZXNbaV07XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgIG9wdGlvbi5pbm5lckhUTUwgPSBgPG9wdGlvbiB2YWx1ZT0ke2l9PiR7YmFzZW5hbWUocGF0aCwgZXh0bmFtZShwYXRoKSl9PC9vcHRpb24+YDtcbiAgICAgICAgICAgIHVpX2ltYWdlcy5hcHBlbmRDaGlsZChvcHRpb24pO1xuICAgICAgICB9XG4gICAgICAgIHVpX2ltYWdlcy5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgYCR7aW5kZXh9YCk7XG4gICAgfSxcblxuICAgIGFzeW5jIG9uQWRkSW1hZ2UoKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERpYWxvZy5zZWxlY3Qoe1xuICAgICAgICAgICAgdGl0bGU6IEkxOG4udCgncmVmZXJlbmNlLWltYWdlLmRpYWxvZy5hZGQtaW1hZ2UtdGl0bGUnKSxcbiAgICAgICAgICAgIHBhdGg6IGF3YWl0IFByb2ZpbGUuZ2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAncm9vdC1wYXRoJykgfHwgJycsXG4gICAgICAgICAgICBmaWx0ZXJzOiBbeyBuYW1lOiAnaW1hZ2UnLCBleHRlbnNpb25zOiBbJ3BuZycsICdqcGcnXSB9XSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghcmVzdWx0IHx8ICFyZXN1bHQuZmlsZVBhdGhzWzBdKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaW1hZ2VzID0gaW1hZ2VzLmNvbmNhdChyZXN1bHQuZmlsZVBhdGhzKTtcbiAgICAgICAgdGhpcy51cGRhdGVJbWFnZXMoKTtcbiAgICAgICAgY29uc3QgcGF0aCA9IGRpcm5hbWUocmVzdWx0LmZpbGVQYXRoc1swXSk7XG4gICAgICAgIGF3YWl0IFByb2ZpbGUuc2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAncm9vdC1wYXRoJywgcGF0aCk7XG4gICAgfSxcblxuICAgIGFzeW5jIG9uRGVsSW1hZ2UoKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERpYWxvZy5pbmZvKEkxOG4udCgncmVmZXJlbmNlLWltYWdlLmRpYWxvZy5kZWxfaW1hZ2VfbWVzc2FnZScpLCB7XG4gICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgSTE4bi50KCdyZWZlcmVuY2UtaW1hZ2UuZGlhbG9nLnllcycpLFxuICAgICAgICAgICAgICAgIEkxOG4udCgncmVmZXJlbmNlLWltYWdlLmRpYWxvZy5jYW5jZWwnKSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBkZWZhdWx0OiAwLFxuICAgICAgICAgICAgY2FuY2VsOiAxLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHJlc3VsdC5yZXNwb25zZSA9PT0gMCkge1xuICAgICAgICAgICAgaW1hZ2VzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICBpbmRleC0tO1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudXBkYXRlSW1hZ2VzKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgYXN5bmMgc3dpdGNoSW1hZ2VzKHBhdGg6IHN0cmluZykge1xuICAgICAgICBkZWJ1Z2dlcjtcbiAgICAgICAgYXdhaXQgTWVzc2FnZS5yZXF1ZXN0KCdzY2VuZScsICdleGVjdXRlLXNjZW5lLXNjcmlwdCcsIHtcbiAgICAgICAgICAgIG5hbWU6ICdyZWZlcmVuY2UtaW1hZ2UnLFxuICAgICAgICAgICAgbWV0aG9kOiAnc3dpdGNoSW1hZ2VzJyxcbiAgICAgICAgICAgIGFyZ3M6IFsgcGF0aCBdLFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgb25Nb3ZlWChldmVudDogRXZlbnQpIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25zdCB4ID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICBhd2FpdCBNZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICAgICAgbmFtZTogJ3JlZmVyZW5jZS1pbWFnZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdtb3ZlWCcsXG4gICAgICAgICAgICBhcmdzOiBbIHggXSxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IFByb2ZpbGUuc2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAneCcsIHgpO1xuICAgIH0sXG5cbiAgICBhc3luYyBvbk1vdmVZKGV2ZW50OiBFdmVudCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHkgPSBldmVudC50YXJnZXQudmFsdWU7XG4gICAgICAgIGF3YWl0IE1lc3NhZ2UucmVxdWVzdCgnc2NlbmUnLCAnZXhlY3V0ZS1zY2VuZS1zY3JpcHQnLCB7XG4gICAgICAgICAgICBuYW1lOiAncmVmZXJlbmNlLWltYWdlJyxcbiAgICAgICAgICAgIG1ldGhvZDogJ21vdmVZJyxcbiAgICAgICAgICAgIGFyZ3M6IFsgeSBdLFxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgUHJvZmlsZS5zZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICd5JywgeSk7XG4gICAgfSxcblxuICAgIGFzeW5jIG9uU2V0T3BhY2l0eShldmVudDogRXZlbnQpIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25zdCBvcGFjaXR5ID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICBhd2FpdCBNZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtc2NlbmUtc2NyaXB0Jywge1xuICAgICAgICAgICAgbmFtZTogJ3JlZmVyZW5jZS1pbWFnZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdzZXRPcGFjaXR5JyxcbiAgICAgICAgICAgIGFyZ3M6IFsgb3BhY2l0eSBdLFxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgUHJvZmlsZS5zZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICdvcGFjaXR5Jywgb3BhY2l0eSk7XG4gICAgfSxcblxuICAgIHJlZ2lzdGVyRXZlbnRMaXN0ZW5lcnMoKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgJCA9IHRoaXMuJDtcbiAgICAgICAgJC54LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbmZpcm0nLCB0aGlzLm9uTW92ZVgpO1xuICAgICAgICAkLnkuYWRkRXZlbnRMaXN0ZW5lcignY29uZmlybScsIHRoaXMub25Nb3ZlWSk7XG4gICAgICAgICQub3BhY2l0eS5hZGRFdmVudExpc3RlbmVyKCdjb25maXJtJywgdGhpcy5vblNldE9wYWNpdHkpO1xuICAgICAgICAkLnVpX2ltYWdlcy5hZGRFdmVudExpc3RlbmVyKCdjb25maXJtJywgdGhpcy5zd2l0Y2hJbWFnZXMpO1xuICAgICAgICAkLmJ0bkFkZC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25BZGRJbWFnZSk7XG4gICAgICAgICQuYnRuRGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vbkRlbEltYWdlKTtcbiAgICB9LFxuXG4gICAgdW5yZWdpc3RlckV2ZW50TGlzdGVuZXJzKCkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0ICQgPSB0aGlzLiQ7XG4gICAgICAgICQueC5yZW1vdmVFdmVudExpc3RlbmVyKCdjb25maXJtJywgdGhpcy5vbk1vdmVYKTtcbiAgICAgICAgJC55LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NvbmZpcm0nLCB0aGlzLm9uTW92ZVkpO1xuICAgICAgICAkLm9wYWNpdHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY29uZmlybScsIHRoaXMub25TZXRPcGFjaXR5KTtcbiAgICAgICAgJC51aV9pbWFnZXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignY29uZmlybScsIHRoaXMuc3dpdGNoSW1hZ2VzKTtcbiAgICAgICAgJC5idG5BZGQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uQWRkSW1hZ2UpO1xuICAgICAgICAkLmJ0bkRlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25EZWxJbWFnZSk7XG4gICAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHJlYWR5ID0gYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IHBhbmVsID0gdGhpcztcbiAgICBwYW5lbC5yZWdpc3RlckV2ZW50TGlzdGVuZXJzKCk7XG4gICAgcGFuZWwuJC54LnZhbHVlID0gYXdhaXQgUHJvZmlsZS5nZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICd4JykgfHwgMDtcbiAgICBwYW5lbC4kLnkudmFsdWUgPSBhd2FpdCBQcm9maWxlLmdldENvbmZpZygncmVmZXJlbmNlLWltYWdlJywgJ3knKTtcbiAgICBwYW5lbC4kLm9wYWNpdHkudmFsdWUgPSBhd2FpdCBQcm9maWxlLmdldENvbmZpZygncmVmZXJlbmNlLWltYWdlJywgJ29wYWNpdHknKTtcbiAgICBpbmRleCA9IGF3YWl0IFByb2ZpbGUuZ2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAnaW5kZXgnKSB8fCBpbmRleDtcbiAgICBwYW5lbC4kLnVpX2ltYWdlcy52YWx1ZSA9IGluZGV4O1xuICAgIGltYWdlcyA9IGF3YWl0IFByb2ZpbGUuZ2V0Q29uZmlnKCdyZWZlcmVuY2UtaW1hZ2UnLCAnaW1hZ2VzJyk7XG4gICAgcGFuZWwudXBkYXRlSW1hZ2VzKCk7XG59O1xuXG5leHBvcnQgY29uc3QgY2xvc2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IHBhbmVsID0gdGhpcztcbiAgICBwYW5lbC51bnJlZ2lzdGVyRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICBhd2FpdCBQcm9maWxlLnNldENvbmZpZygncmVmZXJlbmNlLWltYWdlJywgJ2ltYWdlcycsIGltYWdlcyk7XG4gICAgYXdhaXQgUHJvZmlsZS5zZXRDb25maWcoJ3JlZmVyZW5jZS1pbWFnZScsICdpbmRleCcsIGluZGV4KTtcbn07XG4iXX0=